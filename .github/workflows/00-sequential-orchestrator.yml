name: "ğŸ¼ Sequential CI/CD Orchestrator"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  packages: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Stage 1: Backend Tests (Unit + Integration)
  # ============================================================================
  backend-tests:
    name: "ğŸ§ª Stage 1: Backend Tests (Unit + Integration)"
    uses: ./.github/workflows/02-backend-tests.yml
    secrets: inherit

  # ============================================================================
  # Stage 2: Build & Push (only after Backend Tests succeed)
  # ============================================================================
  build-and-push:
    name: "ğŸš€ Stage 2: Build & Push Container Registry"
    if: success() && github.event_name == 'push'
    needs: backend-tests
    uses: ./.github/workflows/05-build-and-push.yml
    secrets: inherit

  # ============================================================================
  # Final: Report Status
  # ============================================================================
  pipeline-status:
    name: "âœ… Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [backend-tests, build-and-push]
    if: always()

    steps:
      - name: Determine pipeline status
        run: |
          echo "ğŸ¼ Sequential Pipeline Execution Report"
          echo "======================================"
          echo ""
          echo "Stage 1: Backend Tests"
          echo "  Status: ${{ needs.backend-tests.result }}"
          if [ "${{ needs.backend-tests.result }}" == "success" ]; then
            echo "  âœ… Passed - Proceeding to next stage"
          else
            echo "  âŒ Failed - Pipeline halted"
          fi
          echo ""
          echo "Stage 2: Build & Push"
          echo "  Status: ${{ needs.build-and-push.result }}"
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "  âœ… Passed - Ready for deployment"
          elif [ "${{ needs.build-and-push.result }}" == "skipped" ]; then
            echo "  â­ï¸  Skipped - Only runs on push events"
          else
            echo "  âŒ Failed - Pipeline halted"
          fi
          echo ""

      - name: Check overall success
        if: failure()
        run: |
          echo "âŒ Pipeline failed at one or more stages"
          exit 1

      - name: Report success
        if: success()
        run: |
          echo "âœ… All stages completed successfully!"
          echo "ğŸ‰ Pipeline execution complete"
