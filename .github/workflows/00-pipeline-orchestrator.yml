name: "ğŸ¯ Pipeline Orchestrator - Sequencial"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  # ============================================================================
  # STAGE 1: VALIDAÃ‡ÃƒO E TESTES (Backend)
  # ============================================================================
  
  backend-tests:
    name: "Stage 1ï¸âƒ£ - Backend Tests & Lint"
    uses: ./.github/workflows/02-backend-tests.yml
    permissions:
      contents: read
      pull-requests: write
  
  # ============================================================================
  # STAGE 2: TESTES FRONTEND
  # ============================================================================
  
  frontend-tests:
    name: "Stage 2ï¸âƒ£ - Frontend Tests"
    needs: backend-tests
    if: success() && github.event_name != 'pull_request'
    uses: ./.github/workflows/03-frontend-tests.yml
    permissions:
      contents: read
  
  # ============================================================================
  # STAGE 3: SEGURANÃ‡A (Paralelo)
  # ============================================================================
  
  security-scan:
    name: "Stage 3ï¸âƒ£ - Security Scan"
    needs: backend-tests
    if: success()
    uses: ./.github/workflows/01-security-scan.yml
    permissions:
      contents: read
      security-events: write
  
  # ============================================================================
  # STAGE 4: BUILD & PUSH (Imagens Container)
  # ============================================================================
  
  build-and-push:
    name: "Stage 4ï¸âƒ£ - Build & Push"
    needs: [backend-tests, security-scan]
    if: success() && github.event_name == 'push'
    uses: ./.github/workflows/05-build-and-push.yml
    secrets: inherit
    permissions:
      contents: read
      packages: write
  
  # ============================================================================
  # STAGE 5: CONTAINER SCANNING (ApÃ³s build)
  # ============================================================================
  
  container-scan:
    name: "Stage 5ï¸âƒ£ - Container Scan & SBOM"
    needs: build-and-push
    if: success() && github.event_name == 'push'
    uses: ./.github/workflows/04-container-scan.yml
    permissions:
      contents: read
      security-events: write
  
  # ============================================================================
  # FINAL: STATUS E NOTIFICAÃ‡Ã•ES
  # ============================================================================
  
  pipeline-status:
    name: "âœ… Pipeline Status"
    needs: [backend-tests, security-scan, build-and-push, container-scan]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline Status Report
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸ¯ Pipeline Orchestrator - Status            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Stage 1ï¸âƒ£  Backend Tests & Lint:        ${{ needs.backend-tests.result }}"
          echo "âœ… Stage 2ï¸âƒ£  Frontend Tests:              ${{ needs.frontend-tests.result || 'skipped' }}"
          echo "âœ… Stage 3ï¸âƒ£  Security Scan:               ${{ needs.security-scan.result }}"
          echo "âœ… Stage 4ï¸âƒ£  Build & Push:                ${{ needs.build-and-push.result || 'skipped' }}"
          echo "âœ… Stage 5ï¸âƒ£  Container Scan & SBOM:       ${{ needs.container-scan.result || 'skipped' }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Determine Pipeline Status
        if: failure()
        run: exit 1
