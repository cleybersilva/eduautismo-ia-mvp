name: "ğŸ¯ Pipeline Orchestrator - Sequencial"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  # ============================================================================
  # STAGE 1: Security Scan
  # ============================================================================
  security-scan:
    name: "ğŸ”’ Stage 1: Security Scan"
    uses: ./.github/workflows/01-security-scan.yml
    secrets: inherit
  
  # ============================================================================
  # STAGE 2: Backend Tests
  # ============================================================================
  backend-tests:
    name: "ğŸ§ª Stage 2: Backend Tests"
    needs: security-scan
    uses: ./.github/workflows/02-backend-tests.yml
    secrets: inherit
  
  # ============================================================================
  # STAGE 3: Frontend Tests
  # ============================================================================
  frontend-tests:
    name: "ğŸ¨ Stage 3: Frontend Tests"
    needs: backend-tests
    uses: ./.github/workflows/03-frontend-tests.yml
    secrets: inherit
  
  # ============================================================================
  # STAGE 4: Container Scan
  # ============================================================================
  container-scan:
    name: "ğŸ³ Stage 4: Container Scan"
    needs: frontend-tests
    uses: ./.github/workflows/04-container-scan.yml
    secrets: inherit
  
  # ============================================================================
  # STAGE 5: Build & Push
  # ============================================================================
  build-and-push:
    name: "ğŸš€ Stage 5: Build & Push"
    if: success() && github.event_name == 'push'
    needs: container-scan
    uses: ./.github/workflows/05-build-and-push.yml
    secrets: inherit
  
  # ============================================================================
  # FINAL: Pipeline Status
  # ============================================================================
  pipeline-status:
    name: "âœ… Pipeline Status"
    needs: [security-scan, backend-tests, frontend-tests, container-scan, build-and-push]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline Status Report
        run: |
          echo "ğŸ¯ Sequential Pipeline Execution Report"
          echo "======================================"
          echo ""
          echo "Stage 1: Security Scan"
          echo "  Status: ${{ needs.security-scan.result }}"
          [ "${{ needs.security-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 2: Backend Tests"
          echo "  Status: ${{ needs.backend-tests.result }}"
          [ "${{ needs.backend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 3: Frontend Tests"
          echo "  Status: ${{ needs.frontend-tests.result }}"
          [ "${{ needs.frontend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 4: Container Scan"
          echo "  Status: ${{ needs.container-scan.result }}"
          [ "${{ needs.container-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 5: Build & Push"
          echo "  Status: ${{ needs.build-and-push.result }}"
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "  âœ… Passed - Ready for deployment"
          elif [ "${{ needs.build-and-push.result }}" == "skipped" ]; then
            echo "  â­ï¸  Skipped - Only runs on push events"
          else
            echo "  âŒ Failed"
          fi
          echo ""
      
      - name: Check overall success
        if: failure()
        run: |
          echo "âŒ Pipeline failed at one or more stages"
          exit 1
      
      - name: Report success
        if: success()
        run: |
          echo "âœ… All stages completed successfully!"
          echo "ğŸ‰ Pipeline execution complete"
