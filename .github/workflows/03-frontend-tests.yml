name: "ğŸ§ª Test: Frontend (ESLint + Vitest + Build)"

on:
  workflow_call:
    # This workflow can be called by other workflows

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Frontend Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run ESLint
        run: |
          cd frontend
          npm run lint -- --format=json --output-file=eslint-report.json || true
          npm run lint
      
      - name: Format check with Prettier
        run: |
          cd frontend
          npx prettier --check "src/**/*.{js,jsx,css,md}" || true

  test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run Unit Tests (Vitest)
        run: |
          cd frontend
          npm run test -- --run --coverage
      
      - name: Build for production
        run: |
          cd frontend
          npm run build
      
      - name: Verify build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ Build directory not created"
            exit 1
          fi
          if [ "$(ls -A frontend/dist)" ]; then
            echo "âœ… Build successful - $(find frontend/dist -type f | wc -l) files"
          else
            echo "âŒ Build directory is empty"
            exit 1
          fi
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-reports
          path: |
            frontend/eslint-report.json
            frontend/coverage/
            frontend/dist/
      
      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('./frontend/coverage/coverage-final.json', 'utf8'));
              const linesCovered = coverage[Object.keys(coverage)[0]]?.summary?.lines?.pct || 0;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ§ª Frontend Tests\n\nâœ… Tests passed\nğŸ“Š Coverage: ${linesCovered}%\nğŸ—ï¸ Build: SUCCESS`
              });
            } catch (e) {
              console.log('Could not parse coverage:', e.message);
            }
