name: "ğŸ¼ Sequential CI/CD Orchestrator"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  packages: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Stage 1: Backend Tests
  # ============================================================================
  backend-tests:
    name: "ğŸ§ª Stage 1: Backend Tests"
    uses: ./.github/workflows/02-backend-tests.yml
    secrets: inherit

  # ============================================================================
  # Stage 2: Frontend Tests (only after Backend Tests succeed)
  # ============================================================================
  frontend-tests:
    name: "ğŸ¨ Stage 2: Frontend Tests"
    needs: backend-tests
    uses: ./.github/workflows/03-frontend-tests.yml
    secrets: inherit

  # ============================================================================
  # Stage 3: Security Scan (only after Frontend Tests succeed)
  # ============================================================================
  security-scan:
    name: "ğŸ”’ Stage 3: Security Scan"
    needs: frontend-tests
    uses: ./.github/workflows/01-security-scan.yml
    secrets: inherit

  # ============================================================================
  # Stage 4: Container Scan (only after Security Scan succeeds)
  # ============================================================================
  container-scan:
    name: "ğŸ³ Stage 4: Container Scan"
    needs: security-scan
    uses: ./.github/workflows/04-container-scan.yml
    secrets: inherit

  # ============================================================================
  # Stage 5: Build & Push (only after Container Scan succeeds and on push)
  # ============================================================================
  build-and-push:
    name: "ğŸš€ Stage 5: Build & Push"
    if: success() && github.event_name == 'push'
    needs: container-scan
    uses: ./.github/workflows/05-build-and-push.yml
    secrets: inherit

  # ============================================================================
  # Final: Report Status
  # ============================================================================
  pipeline-status:
    name: "âœ… Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, security-scan, container-scan, build-and-push]
    if: always()

    steps:
      - name: Determine pipeline status
        run: |
          echo "ğŸ¼ Sequential Pipeline Execution Report"
          echo "======================================"
          echo ""
          echo "Stage 1: Backend Tests"
          echo "  Status: ${{ needs.backend-tests.result }}"
          [ "${{ needs.backend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 2: Frontend Tests"
          echo "  Status: ${{ needs.frontend-tests.result }}"
          [ "${{ needs.frontend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 3: Security Scan"
          echo "  Status: ${{ needs.security-scan.result }}"
          [ "${{ needs.security-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 4: Container Scan"
          echo "  Status: ${{ needs.container-scan.result }}"
          [ "${{ needs.container-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 5: Build & Push"
          echo "  Status: ${{ needs.build-and-push.result }}"
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "  âœ… Passed - Ready for deployment"
          elif [ "${{ needs.build-and-push.result }}" == "skipped" ]; then
            echo "  â­ï¸  Skipped - Only runs on push events"
          else
            echo "  âŒ Failed"
          fi
          echo ""

      - name: Check overall success
        if: failure()
        run: |
          echo "âŒ Pipeline failed at one or more stages"
          exit 1

      - name: Report success
        if: success()
        run: |
          echo "âœ… All stages completed successfully!"
          echo "ğŸ‰ Pipeline execution complete"