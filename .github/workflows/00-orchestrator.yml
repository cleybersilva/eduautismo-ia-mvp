name: "ğŸ¼ Sequential CI/CD Orchestrator"

on:
  push:
    branches: [dev, staging, main]
  pull_request:
    branches: [dev, staging, main]
    types: [closed]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  packages: write
  actions: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/staging' && 'staging' || 'dev' }}

jobs:
  # ============================================================================
  # Stage 1: Security Scan
  # ============================================================================
  security-scan:
    name: "ğŸ”’ Stage 1: Security Scan"
    uses: ./.github/workflows/01-security-scan.yml
    secrets: inherit

  # ============================================================================
  # Stage 2: Backend Tests (only after Security Scan succeeds)
  # ============================================================================
  backend-tests:
    name: "ğŸ§ª Stage 2: Backend Tests"
    needs: security-scan
    uses: ./.github/workflows/02-backend-tests.yml
    secrets: inherit

  # ============================================================================
  # Stage 3: Frontend Tests (only after Backend Tests succeed)
  # ============================================================================
  frontend-tests:
    name: "ğŸ¨ Stage 3: Frontend Tests"
    needs: backend-tests
    uses: ./.github/workflows/03-frontend-tests.yml
    secrets: inherit

  # ============================================================================
  # Stage 4: Container Scan (only after Frontend Tests succeed)
  # ============================================================================
  container-scan:
    name: "ğŸ³ Stage 4: Container Scan"
    needs: frontend-tests
    uses: ./.github/workflows/04-container-scan.yml
    secrets: inherit

  # ============================================================================
  # Stage 5: Build & Push (only after Container Scan succeeds and on push)
  # ============================================================================
  build-and-push:
    name: "ğŸš€ Stage 5: Build & Push [${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/staging' && 'staging' || 'dev' }}]"
    if: success() && github.event_name == 'push'
    needs: container-scan
    uses: ./.github/workflows/05-build-and-push.yml
    secrets: inherit
    with:
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/staging' && 'staging' || 'dev' }}

  # ============================================================================
  # Final: Report Status
  # ============================================================================
  pipeline-status:
    name: "âœ… Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [security-scan, backend-tests, frontend-tests, container-scan, build-and-push]
    if: always()

    steps:
      - name: Determine pipeline status
        run: |
          ENVIRONMENT="${{ github.ref == 'refs/heads/main' && 'production' || github.ref == 'refs/heads/staging' && 'staging' || 'dev' }}"
          echo "ğŸ¼ Sequential Pipeline Execution Report"
          echo "======================================"
          echo "Environment: $ENVIRONMENT"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Stage 1: Security Scan"
          echo "  Status: ${{ needs.security-scan.result }}"
          [ "${{ needs.security-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 2: Backend Tests"
          echo "  Status: ${{ needs.backend-tests.result }}"
          [ "${{ needs.backend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 3: Frontend Tests"
          echo "  Status: ${{ needs.frontend-tests.result }}"
          [ "${{ needs.frontend-tests.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 4: Container Scan"
          echo "  Status: ${{ needs.container-scan.result }}"
          [ "${{ needs.container-scan.result }}" == "success" ] && echo "  âœ… Passed" || echo "  âŒ Failed"
          echo ""
          echo "Stage 5: Build & Push [$ENVIRONMENT]"
          echo "  Status: ${{ needs.build-and-push.result }}"
          if [ "${{ needs.build-and-push.result }}" == "success" ]; then
            echo "  âœ… Passed - Ready for $ENVIRONMENT deployment"
          elif [ "${{ needs.build-and-push.result }}" == "skipped" ]; then
            echo "  â­ï¸  Skipped - Only runs on push events"
          else
            echo "  âŒ Failed"
          fi
          echo ""

      - name: Check overall success
        if: failure()
        run: |
          echo "âŒ Pipeline failed at one or more stages"
          exit 1

      - name: Report success
        if: success()
        run: |
          echo "âœ… All stages completed successfully!"
          echo "ğŸ‰ Pipeline execution complete"