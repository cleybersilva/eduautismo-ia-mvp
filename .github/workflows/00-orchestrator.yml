name: "ğŸ¼ CI/CD Orchestrator: Sequential Pipeline"name: "ğŸ¼ CI/CD Orchestrator: Sequential Pipeline"



on:on:

  push:  push:

    branches: [main, develop]    branches: [main, develop]

  pull_request:  pull_request:

    branches: [main, develop]    branches: [main, develop]

  schedule:

permissions:    - cron: "0 2 * * *"  # Daily at 2 AM UTC

  contents: read

  pull-requests: writepermissions:

  security-events: write  contents: read

  packages: write  pull-requests: write

  security-events: write

concurrency:  packages: write

  group: ${{ github.workflow }}-${{ github.ref }}

  cancel-in-progress: trueconcurrency:

  group: ${{ github.workflow }}-${{ github.ref }}

jobs:  cancel-in-progress: true

  # ============================================================================

  # Stage 1: Security Scanningjobs:

  # ============================================================================  # ============================================================================

  security-scan:  # Stage 1: Security Scanning

    name: "ğŸ”’ Stage 1: Security Scanning"  # ============================================================================

    runs-on: ubuntu-latest  security-scan:

        name: "ğŸ”’ Stage 1: Security Scanning"

    steps:    uses: ./.github/workflows/01-security-scan.yml

      - name: Checkout code    secrets: inherit

        uses: actions/checkout@v4

        with:  # ============================================================================

          fetch-depth: 0  # Stage 2: Backend Tests (depends on security scan)

        # ============================================================================

      - name: Trigger Security Scan Workflow  backend-tests:

        run: |    name: "ğŸ§ª Stage 2: Backend Tests"

          echo "ğŸ”’ Starting Security Scanning..."    needs: security-scan

          echo "- Secrets scanning (Gitleaks, TruffleHog)"    uses: ./.github/workflows/02-backend-tests.yml

          echo "- Dependency checks (Safety, pip-audit, npm audit)"    secrets: inherit

          echo "- License compliance scan"

          echo "- SAST scanning (Bandit, ESLint)"  # ============================================================================

  # Stage 3: Frontend Tests (depends on backend tests)

  # ============================================================================  # ============================================================================

  # Stage 2: Backend Tests (depends on security scan)  frontend-tests:

  # ============================================================================    name: "ğŸ¨ Stage 3: Frontend Tests"

  backend-tests:    needs: backend-tests

    name: "ğŸ§ª Stage 2: Backend Tests"    uses: ./.github/workflows/03-frontend-tests.yml

    needs: security-scan    secrets: inherit

    runs-on: ubuntu-latest

      # ============================================================================

    steps:  # Stage 4: Container Scan (depends on frontend tests)

      - name: Checkout code  # ============================================================================

        uses: actions/checkout@v4  container-scan:

          name: "ğŸ³ Stage 4: Container Scan"

      - name: Trigger Backend Tests Workflow    needs: frontend-tests

        run: |    uses: ./.github/workflows/04-container-scan.yml

          echo "ğŸ§ª Starting Backend Tests..."    secrets: inherit

          echo "- Lint (Black, isort, flake8, mypy)"

          echo "- Unit & Integration Tests"  # ============================================================================

          echo "- Coverage reporting"  # Stage 5: Build & Push (depends on container scan)

  # ============================================================================

  # ============================================================================  build-and-push:

  # Stage 3: Frontend Tests (depends on backend tests)    name: "ğŸš€ Stage 5: Build & Push"

  # ============================================================================    needs: container-scan

  frontend-tests:    uses: ./.github/workflows/05-build-and-push.yml

    name: "ğŸ¨ Stage 3: Frontend Tests"    secrets: inherit

    needs: backend-tests

    runs-on: ubuntu-latest  # ============================================================================

      # Final: Pipeline Status Report

    steps:  # ============================================================================

      - name: Checkout code  pipeline-status:

        uses: actions/checkout@v4    name: "âœ… Pipeline Complete"

          runs-on: ubuntu-latest

      - name: Trigger Frontend Tests Workflow    needs: [security-scan, backend-tests, frontend-tests, container-scan, build-and-push]

        run: |    if: always()

          echo "ğŸ¨ Starting Frontend Tests..."    

          echo "- Lint & Format (ESLint, Prettier)"    steps:

          echo "- Unit Tests (Vitest)"      - name: Check workflow status

          echo "- Build verification"        run: |

          if [ "${{ needs.security-scan.result }}" == "success" ] && \

  # ============================================================================             [ "${{ needs.backend-tests.result }}" == "success" ] && \

  # Stage 4: Container Scan (depends on frontend tests)             [ "${{ needs.frontend-tests.result }}" == "success" ] && \

  # ============================================================================             [ "${{ needs.container-scan.result }}" == "success" ] && \

  container-scan:             [ "${{ needs.build-and-push.result }}" == "success" ]; then

    name: "ğŸ³ Stage 4: Container Scan"            echo "âœ… All pipeline stages completed successfully!"

    needs: frontend-tests            exit 0

    runs-on: ubuntu-latest          else

                echo "âŒ Pipeline failed at one or more stages"

    steps:            echo ""

      - name: Checkout code            echo "Stage Results:"

        uses: actions/checkout@v4            echo "  ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"

                  echo "  ğŸ§ª Backend Tests: ${{ needs.backend-tests.result }}"

      - name: Trigger Container Scan Workflow            echo "  ğŸ¨ Frontend Tests: ${{ needs.frontend-tests.result }}"

        run: |            echo "  ğŸ³ Container Scan: ${{ needs.container-scan.result }}"

          echo "ğŸ³ Starting Container Scan..."            echo "  ğŸš€ Build & Push: ${{ needs.build-and-push.result }}"

          echo "- Build container images"            exit 1

          echo "- Vulnerability scan (Trivy, Grype)"          fi

          echo "- SBOM generation (Syft)"      

      - name: Comment PR with pipeline status

  # ============================================================================        if: github.event_name == 'pull_request' && always()

  # Stage 5: Build & Push (depends on container scan)        uses: actions/github-script@v7

  # ============================================================================        with:

  build-and-push:          script: |

    name: "ğŸš€ Stage 5: Build & Push"            const status = context.payload.pull_request.head.sha;

    needs: container-scan            const stages = [

    if: github.event_name == 'push'              { name: 'ğŸ”’ Security Scan', result: '${{ needs.security-scan.result }}' },

    runs-on: ubuntu-latest              { name: 'ğŸ§ª Backend Tests', result: '${{ needs.backend-tests.result }}' },

                  { name: 'ğŸ¨ Frontend Tests', result: '${{ needs.frontend-tests.result }}' },

    steps:              { name: 'ğŸ³ Container Scan', result: '${{ needs.container-scan.result }}' },

      - name: Checkout code              { name: 'ğŸš€ Build & Push', result: '${{ needs.build-and-push.result }}' }

        uses: actions/checkout@v4            ];

                  

      - name: Trigger Build & Push Workflow            let body = '## ğŸ¼ CI/CD Pipeline Status\n\n';

        run: |            body += '| Stage | Status |\n';

          echo "ğŸš€ Starting Build & Push..."            body += '|-------|--------|\n';

          echo "- Build and push to registry"            

          echo "- Generate software bill of materials"            let allSuccess = true;

            for (const stage of stages) {

  # ============================================================================              const icon = stage.result === 'success' ? 'âœ…' : 'âŒ';

  # Final: Pipeline Status Report              body += `| ${stage.name} | ${icon} ${stage.result.toUpperCase()} |\n`;

  # ============================================================================              if (stage.result !== 'success') allSuccess = false;

  pipeline-status:            }

    name: "âœ… Pipeline Complete"            

    runs-on: ubuntu-latest            if (allSuccess) {

    needs: [security-scan, backend-tests, frontend-tests, container-scan]              body += '\nğŸ‰ **All stages passed!**';

    if: always()            } else {

                  body += '\nâš ï¸ **Some stages failed. Please check the workflow logs.**';

    steps:            }

      - name: Check workflow status            

        run: |            github.rest.issues.createComment({

          if [ "${{ needs.security-scan.result }}" == "success" ] && \              issue_number: context.issue.number,

             [ "${{ needs.backend-tests.result }}" == "success" ] && \              owner: context.repo.owner,

             [ "${{ needs.frontend-tests.result }}" == "success" ] && \              repo: context.repo.repo,

             [ "${{ needs.container-scan.result }}" == "success" ]; then              body: body

            echo "âœ… All pipeline stages completed successfully!"            });

            exit 0

          else# ============================================================================

            echo "âŒ Pipeline failed at one or more stages"# Pipeline Flow Documentation

            echo ""# ============================================================================

            echo "Stage Results:"# 

            echo "  ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"# This orchestrator workflow ensures sequential execution of all CI/CD stages:

            echo "  ğŸ§ª Backend Tests: ${{ needs.backend-tests.result }}"#

            echo "  ğŸ¨ Frontend Tests: ${{ needs.frontend-tests.result }}"# 1. ğŸ”’ SECURITY SCAN (01-security-scan.yml)

            echo "  ğŸ³ Container Scan: ${{ needs.container-scan.result }}"#    â””â”€ Secrets scanning (Gitleaks, TruffleHog)

            exit 1#    â””â”€ Dependency checks (Safety, pip-audit, npm audit)

          fi#    â””â”€ License compliance scan

      #    â””â”€ SAST scanning (Bandit, ESLint)

      - name: Comment PR with pipeline status#    

        if: github.event_name == 'pull_request' && always()# 2. ğŸ§ª BACKEND TESTS (02-backend-tests.yml) [depends on Stage 1]

        uses: actions/github-script@v7#    â””â”€ Lint (Black, isort, flake8, mypy)

        with:#    â””â”€ Unit & Integration Tests

          script: |#    â””â”€ Coverage reporting

            const stages = [#    

              { name: 'ğŸ”’ Security Scan', result: '${{ needs.security-scan.result }}' },# 3. ğŸ¨ FRONTEND TESTS (03-frontend-tests.yml) [depends on Stage 2]

              { name: 'ğŸ§ª Backend Tests', result: '${{ needs.backend-tests.result }}' },#    â””â”€ Lint & Format (ESLint, Prettier)

              { name: 'ğŸ¨ Frontend Tests', result: '${{ needs.frontend-tests.result }}' },#    â””â”€ Unit Tests (Vitest)

              { name: 'ğŸ³ Container Scan', result: '${{ needs.container-scan.result }}' }#    â””â”€ Build verification

            ];#    

            # 4. ğŸ³ CONTAINER SCAN (04-container-scan.yml) [depends on Stage 3]

            let body = '## ğŸ¼ CI/CD Pipeline Status\n\n';#    â””â”€ Build container images

            body += '| Stage | Status |\n';#    â””â”€ Vulnerability scan (Trivy, Grype)

            body += '|-------|--------|\n';#    â””â”€ SBOM generation (Syft)

            #    

            let allSuccess = true;# 5. ğŸš€ BUILD & PUSH (05-build-and-push.yml) [depends on Stage 4]

            for (const stage of stages) {#    â””â”€ Build and push to registry

              const icon = stage.result === 'success' ? 'âœ…' : stage.result === 'skipped' ? 'â­ï¸' : 'âŒ';#    â””â”€ Generate software bill of materials

              body += `| ${stage.name} | ${icon} ${stage.result.toUpperCase()} |\n`;#    

              if (stage.result !== 'success' && stage.result !== 'skipped') allSuccess = false;# 6. âœ… PIPELINE STATUS [depends on all]

            }#    â””â”€ Report overall pipeline status

            #    â””â”€ Comment on PR with results

            if (allSuccess) {#

              body += '\nğŸ‰ **All stages passed!**';# ============================================================================

            } else {
              body += '\nâš ï¸ **Some stages failed. Please check the workflow logs.**';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

# ============================================================================
# Pipeline Flow Documentation
# ============================================================================
# 
# This orchestrator ensures sequential execution of all CI/CD stages:
#
# 1. ğŸ”’ SECURITY SCAN (01-security-scan.yml)
#    â””â”€ Secrets scanning (Gitleaks, TruffleHog)
#    â””â”€ Dependency checks (Safety, pip-audit, npm audit)
#    â””â”€ License compliance scan
#    â””â”€ SAST scanning (Bandit, ESLint)
#    â””â”€ Each sub-job depends on the previous
#    
# 2. ğŸ§ª BACKEND TESTS (02-backend-tests.yml) [requires Stage 1 success]
#    â””â”€ Lint job (Black, isort, flake8, mypy)
#    â””â”€ Test job [requires Lint success]
#    â””â”€ Coverage reporting
#    
# 3. ğŸ¨ FRONTEND TESTS (03-frontend-tests.yml) [requires Stage 2 success]
#    â””â”€ Lint job (ESLint, Prettier)
#    â””â”€ Test job [requires Lint success]
#    â””â”€ Build verification
#    
# 4. ğŸ³ CONTAINER SCAN (04-container-scan.yml) [requires Stage 3 success]
#    â””â”€ Build container images
#    â””â”€ Scan job [requires Build success]
#    â””â”€ Vulnerability scan (Trivy, Grype)
#    â””â”€ SBOM generation (Syft)
#    
# 5. ğŸš€ BUILD & PUSH (05-build-and-push.yml) [requires Stage 4 success]
#    â””â”€ Build & Push job
#    â””â”€ SBOM job [requires Build & Push success]
#    
# 6. âœ… PIPELINE STATUS [requires all stages]
#    â””â”€ Report overall pipeline status
#    â””â”€ Comment on PR with results
#
# Key Features:
# - Sequential execution: Each stage only starts after previous succeeds
# - Concurrency control: Prevents multiple runs on same ref
# - PR commenting: Reports pipeline status on pull requests
# - Comprehensive logging: Each stage shows what's being executed
#
# ============================================================================
