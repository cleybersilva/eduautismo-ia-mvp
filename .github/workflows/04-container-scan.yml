name: "ğŸ³ Security: Container Image Scan"

on:
  push:
    branches: [main, develop]
    paths:
      - "Dockerfile.*"
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/03-container-scan.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "Dockerfile.*"
      - "backend/**"
      - "frontend/**"
  workflow_call:
    # This workflow can be called by other workflows

permissions:
  contents: read
  security-events: write
  packages: write

jobs:
  build:
    name: Build Container Images
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        image:
          - name: "api"
            file: "Dockerfile.api"
            context: "."
          - name: "web"
            file: "Dockerfile.web"
            context: "."
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.file }}
          push: false
          load: true
          tags: eduautismo-${{ matrix.image.name }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

  scan:
    name: Scan Container Images
    runs-on: ubuntu-latest
    needs: build
    
    strategy:
      matrix:
        image:
          - name: "api"
            file: "Dockerfile.api"
            context: "."
          - name: "web"
            file: "Dockerfile.web"
            context: "."
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0
      
      - name: Build image (for scanning)
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          file: ${{ matrix.image.file }}
          push: false
          load: true
          tags: eduautismo-${{ matrix.image.name }}:scan
          cache-from: type=gha
      
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: eduautismo-${{ matrix.image.name }}:scan
          format: 'sarif'
          output: 'trivy-${{ matrix.image.name }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
      
      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: |
            trivy-api.sarif
            trivy-web.sarif
            trivy-config.sarif
          category: 'trivy-${{ matrix.image.name }}'
        continue-on-error: true
      
      - name: Scan with Grype
        uses: anchore/scan-action@v3
        with:
          image: eduautismo-${{ matrix.image.name }}:scan
          fail-build: false
          severity-cutoff: high
        continue-on-error: true
      
      - name: Upload Grype results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('results.sarif') != ''
        with:
          sarif_file: results.sarif
          category: 'grype-${{ matrix.image.name }}'
        continue-on-error: true
      
      - name: Save Docker image for SBOM analysis
        run: |
          docker save eduautismo-${{ matrix.image.name }}:scan -o sbom-${{ matrix.image.name }}.tar
          ls -lh sbom-${{ matrix.image.name }}.tar
      
      - name: Generate SBOM with Syft (SPDX)
        continue-on-error: true
        run: |
          echo "ğŸ” Generating SPDX SBOM for eduautismo-${{ matrix.image.name }}..."
          syft packages 'docker-archive://sbom-${{ matrix.image.name }}.tar' \
            -o spdx-json > sbom-${{ matrix.image.name }}.json
          
          if [ -f "sbom-${{ matrix.image.name }}.json" ]; then
            echo "âœ… SPDX SBOM generated successfully"
            wc -l sbom-${{ matrix.image.name }}.json
          else
            echo "âš ï¸  SPDX SBOM generation failed"
          fi
      
      - name: Generate CycloneDX SBOM
        continue-on-error: true
        run: |
          echo "ğŸ” Generating CycloneDX SBOM for eduautismo-${{ matrix.image.name }}..."
          syft packages 'docker-archive://sbom-${{ matrix.image.name }}.tar' \
            -o cyclonedx-json > sbom-${{ matrix.image.name }}-cyclonedx.json
          
          if [ -f "sbom-${{ matrix.image.name }}-cyclonedx.json" ]; then
            echo "âœ… CycloneDX SBOM generated successfully"
            wc -l sbom-${{ matrix.image.name }}-cyclonedx.json
          else
            echo "âš ï¸  CycloneDX SBOM generation failed"
          fi
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.image.name }}
          path: sbom-${{ matrix.image.name }}-*.json
      
      - name: Comment PR with scan results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { default: fetch } = require('node-fetch');
            
            let comment = `## ğŸ³ Container Scan Results: ${{ matrix.image.name }}\n\n`;
            comment += `**Image**: \`eduautismo-${{ matrix.image.name }}\`\n\n`;
            
            try {
              const trivy = JSON.parse(fs.readFileSync('trivy-${{ matrix.image.name }}.sarif', 'utf8'));
              const results = trivy.runs[0]?.results || [];
              
              const critical = results.filter(r => r.level === 'error').length;
              const high = results.filter(r => r.level === 'warning').length;
              const medium = results.filter(r => r.level === 'note').length;
              
              comment += `### Vulnerabilities\n`;
              comment += `- ğŸ”´ Critical: ${critical}\n`;
              comment += `- ğŸŸ  High: ${high}\n`;
              comment += `- ğŸŸ¡ Medium: ${medium}\n\n`;
              
              if (critical === 0 && high === 0) {
                comment += `âœ… No critical/high vulnerabilities found!\n`;
              }
            } catch (e) {
              comment += `âš ï¸ Could not parse scan results\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
